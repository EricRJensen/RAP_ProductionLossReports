---
params:
  new_title: params$new_title
  main_df: params$main_df
  cty_sf: params$cty_sf
  sta_sf: params$sta_sf
  sta_ctys_sf: params$sta_ctys_sf
  current_year: params$current_year
  rap_url: params$rap_url
  sta_path: params$sta_path
  csv_path: params$csv_path
  type: params$type
title: "`r params$new_title`"
author: "`r params$type`-level rangeland production report derived from the Rangeland Analysis Platform" 
output: html_document
---

```{r setup, include=FALSE}
library(here)
knitr::opts_chunk$set(echo = TRUE, root.dir = here())
library(tidyverse)
library(sf)
library(knitr)
require(scales)
library(reshape2)
library(leaflet)
library(leaflet.extras)
```
#### [`r ifelse(grepl(",", params$new_title) == TRUE, str_split(params$new_title, ',')[[1]][2], params$new_title)`](`r params$sta_path`) `r ifelse(params$type == 'County', paste('>',str_split(loc_name, ',')[[1]][1], sep = ' '), '')`
  
## `r paste(params$type, ' map')` 
Click any county on the map below to see its report
```{r echo = FALSE, warning = FALSE, fig.width=10, fig.height=5}

if (params$type == 'County'){
  leaflet(options = leafletOptions(zoomControl = FALSE,  minZoom = 6, maxZoom = 8, dragging = FALSE, attributionControl=FALSE)) %>%
    addPolygons(data = params$sta_sf, fillColor = "#00000000", color = '#5e5e5e', opacity = 1) %>%
    addPolygons(data = params$cty_sf, fillColor = "#455eff", color = '#00000000', weight = 3, opacity = 1, fillOpacity = 1) %>%
    addPolygons(data = params$sta_ctys_sf, fillColor = "#00000000", color = '#5e5e5e', weight = 1.5, opacity = 1, label = ~NAMELSAD, popup = paste(sta_ctys_sf$NAMELSAD, "<BR>", "<a href =   '",sta_ctys_sf$path, "' target = '_blank'>", 'See the report </a>'),
                labelOptions = labelOptions(style = list(
                                              "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
                                              "font-size" = "16px"
                                            )))  %>%
    setMapWidgetStyle(list(background= "white")) 
  } else if (params$type == 'State') {
  leaflet(options = leafletOptions(zoomControl = FALSE,  minZoom = 6, maxZoom = 8, dragging = FALSE, attributionControl=FALSE)) %>%
    addPolygons(data = params$sta_sf, fillColor = "#00000000", color = '#5e5e5e', opacity = 1) %>%
    addPolygons(data = params$sta_ctys_sf, fillColor = "#00000000", color = '#5e5e5e', weight = 1.5, opacity = 1, label = ~NAMELSAD, popup = paste(sta_ctys_sf$NAMELSAD, "<BR>", "<a href =   '",sta_ctys_sf$path, "' target = '_blank'>", 'See the report </a>'),
                labelOptions = labelOptions(style = list(
                                              "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
                                              "font-size" = "16px"
                                            )))  %>%
    setMapWidgetStyle(list(background= "white"))
}



```
  
  
|
|
## Summary statistics
*Data are current through the year `r params$current_year` *  

```{r echo = FALSE}
# Statistics for report
yr_rec <- params$current_year
figure_v <- c("Figure 1", "Figure 2", "", "", "Figure 3", "Figure 4")
main_df_rec <- filter(params$main_df, year == yr_rec)
stat_df <- tibble(`Annual rangeland production` = paste(as.character(round(main_df_rec$biomass,0)), 'lbs'),
                  `Tree cover area` = paste(as.character(round(main_df_rec$treeArea,0)), 'acres'),
                  `Acres lost to tree expansion since 1990` = paste(as.character(round((head(params$main_df$treeArea, n = 1)) - (tail(params$main_df$treeArea, n = 1)), 0)), 'acres'),
                  `Tree cover percentage` = paste(as.character(round(main_df_rec$treeCover,2)),'%', sep = ''),
                  `Annual forage loss resulting from tree expansion` = paste(as.character(round(main_df_rec$yieldgap,0)), 'lbs'),
                  `Total forage loss resulting from tree expansion (1986-present)` = paste(as.character(round(sum(params$main_df$yieldgap),0)), 'lbs')) %>%
  t() %>%
  melt() %>%
  mutate(Figure = figure_v[row_number()],
         Value = prettyNum(value, big.mark = ",")) %>%
  select(c(Variable = Var1, Value, Figure))
kable(stat_df)
```

|
|
## Time-series plots  
#### Figure 1  
```{r echo = FALSE}
# Annual production plot
ggplot()+
  geom_line(params$main_df, mapping = aes(x = year, y = biomass), color = 'grey20', size = 1)+
  labs(title = 'Annual rangeland production', y = 'Annual production (lbs)')+
  scale_y_continuous(labels = comma, limits = c(0, max(params$main_df$biomass)*1.1))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_minimal()+
  theme(axis.title.x=element_blank())
        #axis.text.y = element_text(angle = 45))
```

|
#### Figure 2    
```{r echo = FALSE}
# Tree cover area
ggplot()+
  geom_line(params$main_df, mapping = aes(x = year, y = treeArea), color = '#0E8E00', size = 1)+
  labs(title = 'Tree cover area', y = 'Tree cover (acres)')+
  scale_y_continuous(labels = comma, limits = c(0, max(params$main_df$treeArea)*1.1))+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_minimal()+
  theme(axis.title.x=element_blank())
```
  
|
#### Figure 3  
```{r echo = FALSE}
# Yield gap
ggplot()+
  geom_line(params$main_df, mapping = aes(x = year, y = yieldgap), color = 'red', size = 1)+
  labs(title = 'Annual forage loss to tree expansion', y = 'Forage lost (lbs)')+
  coord_cartesian(ylim = c(min(params$main_df$yieldgap)*1.1,max(params$main_df$yieldgap)*1.1))+
  scale_y_continuous(labels = comma)+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_minimal()+
  theme(axis.title.x=element_blank())
```
  
|
#### Figure 4  
```{r echo = FALSE}
# Cumulative yield gap
options(scipen = 100)
ggplot()+
  geom_line(params$main_df, mapping = aes(x = year, y = cumYieldGap), color = 'red', size = 1)+
  labs(title = 'Cumulative forage loss to tree expansion', y = 'Forage lost (lbs)')+
  coord_cartesian(ylim = c(min(params$main_df$cumYieldGap)*1.1,max(params$main_df$cumYieldGap)*1.1))+
  scale_y_continuous(labels = comma)+
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_minimal()+
  theme(axis.title.x=element_blank())
```

|
#### Figure 5: Time-series encroachment and dispersal plot   
```{r echo = FALSE}
plot_df <- params$main_df %>%
  mutate(coniferSum = (classWoodlands + classEncroached + classDispersal + classRecruitment),
         classIntact = analysisArea - coniferSum,
         Woodlands = classWoodlands/analysisArea,
         Encroached = classEncroached/analysisArea,
         Dispersal = classDispersal/analysisArea,
         Recruitment = classRecruitment/analysisArea,
         Intact = classIntact/analysisArea) %>%
  select(c(year, Woodlands, Encroached, Recruitment, Dispersal, Intact)) %>%
  melt(id = 'year')

ggplot()+
  geom_bar(plot_df, mapping = aes(fill = variable, x = year, y = value*100), position = "stack", stat = "identity")+
  labs(y = 'Cover (%)')+
  scale_fill_manual(
        values = c(
          Woodlands = "grey40",
          Encroached = "#CB4C4E",
          Recruitment = "#FF9E44",
          Dispersal = "#FDE64B",
          Intact = "#4F963C"))+
  theme_minimal()+
  theme(legend.title = element_blank(),
        axis.title.x=element_blank())
```

## Reference
Access the complete data that from which this report is derived:  

* [View tree cover data in the Rangeland Analysis Platform web application](`r params$rap_url`){target="_blank"}  
* [Download complete tree cover change time-series CSV](`r params$csv_path`)  
  
  
  
  
  
  
  
*Report generated on `r Sys.Date()`.*